---
title: "Session 6: Homework 3"
author: "Study Group 7"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: flatly
    highlight: zenburn
    number_sections: yes
    toc: yes
    toc_float: yes
    code_folding: show
---


```{r, setup, echo=FALSE}
knitr::opts_chunk$set(
  message = FALSE, 
  warning = FALSE, 
  tidy=FALSE,     # display code as typed
  size="small")   # slightly smaller font for code
options(digits = 3)

# default figure size
knitr::opts_chunk$set(
  fig.width=6.75, 
  fig.height=6.75,
  fig.align = "center"
)
```


```{r load-libraries, echo=FALSE}
library(tidyverse)  # Load ggplot2, dplyr, and all the other tidyverse packages
library(mosaic)
library(ggthemes)
library(GGally)
library(readxl)
library(here)
library(skimr)
library(janitor)
library(broom)
library(tidyquant)
library(infer)
library(openintro)
```


# Youth Risk Behavior Surveillance

```{r}
data(yrbss)
glimpse(yrbss)
```

## Exploratory Data Analysis

Lets start by analyzing the `weight` of participants in kilograms.

```{r, eda_on_weight}
skim(yrbss$weight)
```
We are missing 1004 observations.

Next, consider the possible relationship between a high schooler’s weight and their physical activity. Plotting the data is a useful first step because it helps us quickly visualize trends, identify strong associations, and develop research questions.

Let’s create a new variable `physical_3plus`, which will be `yes` if they are physically active for at least 3 days a week, and `no` otherwise.

  
```{r}
yrbss <- yrbss %>% 
  mutate(physical_3plus = ifelse(physically_active_7d >= 3, "yes", "no"))

yrbss_summary <- yrbss %>% filter(!is.na(physical_3plus)) %>% 
  group_by(physical_3plus) %>% 
  summarise(count = n()) %>% 
  mutate(prop= count/sum(count))

```
Lets create a 95% confidence interval for the population proportion of high schools that are *NOT* active 3 or more days per week?

```{r, boxplot}
#sum population
count_pop <- yrbss_summary  %>%  summarise(sum = sum(count))
#calculating the SE
se_pop <- sqrt(yrbss_summary$prop[1] * (1-yrbss_summary$prop[1])/count_pop)
#calculating the mean
mean_pop <- yrbss_summary$prop[1]
#t-critical value
t_critical <- qt(0.975, count_pop$sum-1)
lower_ci <- mean_pop - t_critical * se_pop
upper_ci <- mean_pop + t_critical * se_pop

paste("Proportion of high schollers that are not active 3 or more days per week: ", mean_pop)
paste("CI high schollers that are not active 3 or more days per week: ", lower_ci,",", upper_ci)

```

Make a boxplot of `physical_3plus` vs. `weight`. Is there a relationship between these two variables? What did you expect and why?

```{r, boxplot_physical_weight}
#boxplot
yrbss_clean <- na.omit(yrbss)
boxplot_pop <- ggplot(data = yrbss_clean, aes(x = physical_3plus,y= weight)) + geom_boxplot()
 
#calculating the mean and the median of the weight
yrbss_clean %>%  group_by(physical_3plus)%>% summarize(mean  = mean(weight), median = median(weight))
```

There is a small correlation between the ones doing more/less exercises and the weight. However, they are somehow similar, but they are lower in people who do less exercises.

## Confidence Interval

Boxplots show how the medians of the two distributions compare, but we can also compare the means of the distributions using either a confidence interval or a hypothesis test. Note that when we calculate the mean/SD, etc weight in these groups using the mean function, we must ignore any missing values by setting the `na.rm = TRUE`.


```{r}
yrbss %>%
  group_by(physical_3plus) %>%
  filter(!is.na(physical_3plus)) %>% 
  summarise(mean_weight = mean(weight, na.rm = TRUE),
            sd_weight = sd(weight, na.rm=TRUE),
            count = n(),
            se_weight = sd_weight/sqrt(count),
            t_critical = qt(0.975, count-1), 
            margin_of_error = t_critical * se_weight,
            lower = mean_weight - t_critical * se_weight,
            upper = mean_weight + t_critical * se_weight
            )

```

There is an observed difference of about 1.77kg (68.44 - 66.67), and we notice that the two confidence intervals do not overlap. It seems that the difference is at least 95% statistically significant. Let us also conduct a hypothesis test.

## Hypothesis test with formula

Write the null and alternative hypotheses for testing whether mean weights are different for those who exercise at least times a week and those who don’t.

```{r}
t.test(weight ~ physical_3plus, data = yrbss)
```

h0: mean of the first group is equal of mean of the second group
h1: means are not equal

## Hypothesis test with `infer`

Next, we will introduce a new function, `hypothesize`, that falls into the infer workflow. You will use this method for conducting hypothesis tests.

But first, we need to initialize the test, which we will save as `obs_diff`.

```{r}
obs_diff <- yrbss %>%
  specify(weight ~ physical_3plus) %>%
  calculate(stat = "diff in means", order = c("yes", "no"))

```



Notice how you can use the functions specify and calculate again like you did for calculating confidence intervals. Here, though, the statistic you are searching for is the difference in means, with the order being yes - no != 0.

After you have initialized the test, you need to simulate the test on the null distribution, which we will save as null.


```{r}
null_dist <- yrbss %>%
  specify(weight ~ physical_3plus) %>%
  hypothesize(null = "independence") %>%
  generate(reps = 1000, type = "permute") %>%
  calculate(stat = "diff in means", order = c("yes", "no"))

```


Here, `hypothesize` is used to set the null hypothesis as a test for independence, i.e., that there is no difference between the two population means. In one sample cases, the null argument can be set to *point* to test a hypothesis relative to a point estimate.

Also, note that the `type` argument within generate is set to permute, which is the argument when generating a null distribution for a hypothesis test.

We can visualize this null distribution with the following code:

```{r}
ggplot(data = null_dist, aes(x = stat)) +
  geom_histogram()

```


Now that the test is initialized and the null distribution formed, we can visualise to see how many of these null permutations have a difference of at least `obs_stat` of `r obs_diff %>% pull() %>% round(2)`?

We can also calculate the p-value for your hypothesis test using the function `infer::get_p_value()`.

obs_diff = 1.77

```{r}

null_dist %>% visualize() +
  shade_p_value(obs_stat = obs_diff, direction = "two-sided")


```


This the standard workflow for performing hypothesis tests.

# IMDB ratings: Differences between directors

Lets look at the average ratings for Steven Spielberg and Tim Burton and analyse whether they are significantly different from each other.

```{r load-movies-data}
movies <- read_csv(here::here("data", "movies.csv"))
glimpse(movies)
```

The hypotheses are as stated below: 

Null hypothesis (H0) = The mean IMDB ratings for Steven Spielberg and Tim Burton are equal, i.e. the difference between the two means = 0
Alternate hypothesis (H1) = The mean IMDB ratings for Steven Spielberg and Tim Burton are not equal, i.e. they are significantly different

```{r sort_movies}


selected_directors_statistic <- movies %>% 
  #filtering dataframe to only include Spielberg and Burton
  filter(director == "Steven Spielberg" | director == "Tim Burton") %>% 
  group_by(director) %>% 
  summarise(mean = mean(rating), sd = sd(rating), count = n(), se = sd / sqrt(count), t_critical = qt(0.975, count - 1),
            lower_ci = mean - t_critical * se, upper_ci = mean + t_critical * se, rating = rating) 

#Creating the t-statistic
t_statistic <- t.test(rating ~ director, data = selected_directors_statistic)
t_statistic

```

Since the t-statistic value is > 2 and p-value < 0.05 (alpha), we reject the null hypothesis and conclude that mean IMDB ratings for Steven Spielberg and Tim Burton are significantly different. 

```{r plot movies}

#selecting spielberg and burton
selected_directors <- movies %>% 
  filter(director == "Steven Spielberg" | director == "Tim Burton") %>% 
  group_by(director) %>% 
  summarise(mean = mean(rating), sd = sd(rating), count = n(), se = sd / sqrt(count), t_critical = qt(0.975, count - 1),
            lower_ci = mean - t_critical * se, upper_ci = mean + t_critical * se) 

#plotting the convidence intervals of both movies
imdb_spielberg_and_burton <- ggplot(selected_directors, aes(x = mean, y = reorder(director, mean))) +
  geom_rect(xmin = 7.27, xmax = 7.33, ymin = 0, ymax = 10, fill = "grey", aes(alpha = 0.5)) +
  geom_point(size = 3, shape = 16) +
  geom_text(aes(label = round(mean, 2)), size = 5, hjust = 0.4, vjust = -1) +
  geom_errorbar(aes(xmin = lower_ci, xmax = upper_ci, colour = director, fill = director), width = 0.2, size = 1.5) +
  scale_fill_manual(values = c("#FA8072", "#48D1CC")) +
  geom_text(aes(label = round(lower_ci, 2)), hjust = 4, vjust = - 1) +
  geom_text(aes(label = round(upper_ci, 2)), hjust = - 4, vjust = - 1) +
  theme_bw() +
  theme(legend.position = "none") +
  ggtitle("Do Spielberg and Burton have the same IMDB ratings") +
  theme(plot.title = element_text(face = "bold")) +
  labs(subtitle = "95% confidence intervals overlap", x = "Mean IMDB ratings", y = "") +
  theme(aspect.ratio=3/5) 

ggsave("imdb_spielberg_and_burton.jpg",plot=imdb_spielberg_and_burton,width = 10,height = 6, path = here::here("images"))

#displaying the plot
knitr::include_graphics(here::here("images", "imdb_spielberg_and_burton.jpg"))

  

```
Since there is an overlap in the confidence intervals for both directors, we reject the null hypothesis in favour of the alternate hypothesis i.e. there is a significant difference in the mean ratings of Steven Spielberg and Tim Burton. 

We now use the infer() package to simulate from a null distribution where we assume that the means are equal.

```{r use_infer, echo = TRUE}

obs_diff_mean <- selected_directors_statistic %>% 
    specify(rating ~ director) %>% 
    calculate(stat = "diff in means", order = c("Steven Spielberg", "Tim Burton"))
obs_diff_mean
  
set.seed(1234)

ratings_in_null_world <- selected_directors_statistic %>% 
  specify(rating ~ director) %>% 
  hypothesise(null = "independence") %>% 
  generate(rep = 1000, type = "permute") %>% 
  calculate(stat = "diff in means", order = c("Steven Spielberg", "Tim Burton"))

visualise(ratings_in_null_world, bins = 10) +
  shade_p_value(obs_stat = obs_diff_mean, direction = "both") +
  theme_bw()

p_value <- ratings_in_null_world %>% 
  get_p_value(obs_stat = obs_diff_mean, direction = "both")
p_value

```

When we use the `infer` package to simulate from a null distribution we get a p-value of 0.004 < 0.05, therefore we can conclude that the difference in our sample is not zero and there is significant difference in mean ratings of movies by the two directors. 

# Omega Group plc- Pay Discrimination

Lets find out whether there is indeed a significant difference between the salaries of men and women, and whether the difference is due to discrimination or whether it is based on another, possibly valid, determining factor. 

## Loading the data


```{r load_omega_data}
omega <- read_csv(here::here("data", "omega.csv"))
glimpse(omega) # examine the data frame
```

## Relationship Salary - Gender ?

The data frame `omega`  contains the salaries for the sample of 50 executives in the company. Lets look at whether we can conclude that there is a significant difference between the salaries of the male and female executives?

```{r, confidence_intervals_salary_bootstrap}

#calculating the salary values with 95% confidence
salary_bootstrap_male <- omega %>% 
  filter(gender == "male") %>% 
  # Specify the variable of interest
  specify(response = salary) %>%
  generate(reps = 1000, type = "bootstrap") %>%
  # Find the mean of each sample
  calculate(stat = "mean")
  #get_confidence_interval(level=0.95, type="percentile")
  
salary_bootstrap_female <- omega %>% 
  filter(gender == "female") %>% 
  # Specify the variable of interest
  specify(response = salary) %>%
  generate(reps = 1000, type = "bootstrap") %>%
  # Find the mean of each sample
  calculate(stat = "mean")
  
#calculating confidence intervals for male and female salary
male_ci <- salary_bootstrap_male %>% 
  get_confidence_interval(level=0.95, type="percentile")
female_ci <- salary_bootstrap_female %>% 
  get_confidence_interval(level=0.95, type="percentile")

#adding a gender column to the bootstrapped salary data
salary_bootstrap_female <- salary_bootstrap_female %>% 
  mutate(gender = "female")
salary_bootstrap_male <- salary_bootstrap_male %>% 
  mutate(gender = "male")

#combnining both dataframes 
combined_salary_bootstrap <- rbind(salary_bootstrap_female, salary_bootstrap_male)
  
#plotting density of both dataframes
ggplot(combined_salary_bootstrap) + 
  shade_confidence_interval(male_ci, fill = "#69D4D8", color = "#69D4D8", alpha=0.3) +
  shade_confidence_interval(female_ci, fill = "#FEA9A7", color = "#FEA9A7", alpha=0.3) +
  geom_density(aes(x=stat, fill=gender, fill=gender), color="black", alpha = 0.3) +
  labs(title = "On average men and women have large differences in yearly salary!", x = "Salary", y = "Density", subtitle = "95% confidence interval shaded") + 
  theme_bw()


```


Lets calculate summary statistics on salary by gender.

```{r, confint_single_valiables}
# Summary Statistics of salary by gender
mosaic::favstats (salary ~ gender, data=omega)

#Calculating the confidence intervals using the formula
formula_ci <- omega %>% 
  group_by(gender) %>% 
  summarise(mean_salary = mean(salary, na.rm = TRUE), 
            sd_salary = sd(salary, na.rm = TRUE), 
            count_salary = n(), 
            se_salary = sd_salary/sqrt(count_salary), 
            t_critical = qt(0.975, count_salary-1),
            lower_salary = mean_salary - t_critical * se_salary,
            upper_salary = mean_salary + t_critical * se_salary)

formula_ci

```

Lets run a hypothesis test, assuming as a null hypothesis that the mean difference in salaries is zero, or that, on average, men and women make the same amount of money.

```{r, hypothesis_testing_t_test}

#bootsrapping 1000 samples
set.seed(1234)
salary_in_equal_world <- omega %>% 
  specify(salary ~ gender) %>% 
  hypothesize(null = "independence") %>% 
  generate(reps = 1000, type = "permute") %>% 
  calculate(stat = "diff in means",
            order = c("male", "female"))

test <- t.test(salary ~ gender, data = omega)
test


```

```{r, visualize_p_test}

salary_in_equal_world %>%  visualize() + 
  shade_p_value(obs_stat = test$p.value, direction = "two-sided") + 
  labs(title = "Differences in salary between male and female executives in a world where there \nis really no difference", x = "Average Female - Average Male Salary", y = "Count", subtitle = "Observed differences marked in red") +
  theme_bw()

```

H0: There is no significant difference in salary between genders
H1: Mean salary between gender differs


The extremeley low p-value of 0.000165 suggests that the probability of observing the sample mean, given that the H0 is true, is very low. Therefore this allows us to reject the H0 that there is no signficant difference in salary between genders in favor of our H1. Further support for this is the high t-value of -4, as well as the non-overlapping confidence intervals. 

Therefore this hypothesis test suggests that on average salary between men and women is not distributed equally.


## Relationship Experience - Gender?

At the board meeting, someone raised the issue that there was indeed a substantial difference between male and female salaries, but that this was attributable to other reasons such as differences in experience. A questionnaire send out to the 50 executives in the sample reveals that the average experience of the men is approximately 21 years, whereas the women only have about 7 years experience on average (see table below).

```{r, experience_stats}
# Summary Statistics of salary by gender
favstats (experience ~ gender, data=omega)

```

Based on this evidence, can you conclude that there is a significant difference between the experience of the male and female executives? Perform similar analyses as in the previous section. Does your conclusion validate or endanger your conclusion about the difference in male and female salaries?  


```{r, experience_stats_self}

#calculating the salary values with 95% confidence
experience_bootstrap_male <- omega %>% 
  filter(gender == "male") %>% 
  # Specify the variable of interest
  specify(response = experience) %>%
  generate(reps = 1000, type = "bootstrap") %>%
  # Find the mean of each sample
  calculate(stat = "mean")
  #get_confidence_interval(level=0.95, type="percentile")
  
experience_bootstrap_female <- omega %>% 
  filter(gender == "female") %>% 
  # Specify the variable of interest
  specify(response = experience) %>%
  generate(reps = 1000, type = "bootstrap") %>%
  # Find the mean of each sample
  calculate(stat = "mean")

#calculating confidence intervals
male_ci <- experience_bootstrap_male %>% 
  get_confidence_interval(level=0.95, type="percentile")
female_ci <- experience_bootstrap_female %>% 
  get_confidence_interval(level=0.95, type="percentile")

#adding a gender column to the bootstrapped experience data
experience_bootstrap_female <- experience_bootstrap_female %>% 
  mutate(gender = "female")
experience_bootstrap_male <- experience_bootstrap_male %>% 
  mutate(gender = "male")

#combnining both dataframes 
combined_experience_bootstrap <- rbind(experience_bootstrap_female, experience_bootstrap_male)
  
#plotting density of both dataframes
ggplot(combined_experience_bootstrap) + 
  geom_density(aes(x=stat, fill=gender, fill=gender),color="black", alpha = 0.3) +
  shade_confidence_interval(male_ci, fill = "#69D4D8", color = "#69D4D8", alpha=0.3) +
  shade_confidence_interval(female_ci, fill = "#FEA9A7", color = "#FEA9A7", alpha=0.3) +
  labs(title = "On average men have more work experience than women in similar positions!", x = "Years of experience", y = "Density", subtitle = "95% confidence interval shaded") +
  theme_bw()

```


```{r, hypothesis_testing_t_test_experience}

set.seed(1234)
salary_in_equal_world <- omega %>% 
  specify(experience ~ gender) %>% 
  hypothesize(null = "independence") %>% 
  generate(reps = 1000, type = "permute") %>% 
  calculate(stat = "diff in means",
            order = c("female", "male"))

test <- t.test(experience ~ gender, data = omega)
test

```
H0: There is no significant difference in experience between genders
H1: Mean experience between gender differs


The extremeley low p-value of 0.0000123 suggests that the probability of observing the sample mean, given that the H0 is true, is very low. Therefore this allows us to reject the H0 that there is no signficant difference in experience between genders in favor of our H1. Further support for this is the high t-value of -5, as well as the non-overlapping confidence intervals. 

Therefore this hypothesis test suggests that on average experience between men and women is not distributed equally.

## Relationship Salary - Experience ?

Someone at the meeting argues that clearly, a more thorough analysis of the relationship between salary and experience is required before any conclusion can be drawn about whether there is any gender-based salary discrimination in the company.

Analyse the relationship between salary and experience. Draw a scatterplot to visually inspect the data


```{r, salary_exp_scatter}
ggplot(omega, aes(x=experience, y=salary)) + 
  geom_smooth(method = "lm", color="black") + 
  geom_point(aes(color=gender), alpha=0.6) + 
  annotate(x=25, y=79000, 
         label=paste("R = ", round(cor(omega$salary, omega$experience),3)), 
         geom="text", size=5) +
  labs(title = "On average increased job experience leads to an increased yearly salary!", x = "Years of experience", y = "Yearly Salary", subtitle = "Correlation between yearly income and years of job experience") +
  theme_bw()
  

```


## Check correlations between the data

Lets take a look correlation matrix to closer inspect the correlation between these variables.

```{r, ggpairs}
omega %>% 
  select(gender, experience, salary) %>% #order variables they will appear in ggpairs()
  ggpairs(aes(colour=gender, alpha = 0.3))+
  theme_bw()
```

When looking at the salary vs experience scatterplot it becomes apparent that there is a strong positive correlation between these two variables. Thus suggesting that, on average, an individual having more work experience will be earning more money than those with very little experience. Logically thinking this is a reasonable trend, as one would assume individuals with more experience to be more efficient at their jobs. 

An other interesting observation that can be inferred from this is the fact that the average work experience of men is much greater than that of women. Thus, this could be one the factors, leading to the lower average salary earned by female workers.

# Challenge 1: Brexit plot

Lets take a look at how politifcal affiliation influenced the Brexit voting.

```{r brexit_challenge_self}

#importing our dataframe and assigning it to a variable
brexit <- read_csv(here::here("data", "brexit_results.csv"))
glimpse(brexit)

#trasnforming it into a long df
brexit_long <- gather(brexit, party, percentage, con_2015:ukip_2015, factor_key=TRUE)

#building our graph with ggplot
challenge1 <- ggplot(brexit_long, aes(x = percentage ,y=leave_share, color = party))+
  geom_point(size = 2, alpha = 0.5) +
  geom_smooth(method = lm) +
  #adding titles to the graph/axis
  theme(legend.position = "bottom", legend.direction = "horizontal") +
  labs(title = "How political affiliation translated to brexit Voting", 
    x = "Party % in the UK 2015 general election", 
    y = "Leave % in the 2016 Brexit referendum") +
  #defining the limits of the x axis
  scale_x_discrete(expand=c(0.05,0.05),limits=c(0 ,20, 40, 60, 80))+
  #changing legend (color, name and labels)
  scale_color_manual(values = c("#0087DC","#DC241f","#FDBB30","#EFE600"),name = "", labels = c("Conservative", "Labour", "Lib Dems", "UKIP") )+ 
  #changing theme aspects
  theme_bw() +
  theme(legend.position="bottom", 
        plot.title = element_text(face = "bold"),
        aspect.ratio=2/3.8,
        text = element_text(size=17)) 

# Save plot as a picture
ggsave("challenge1.jpg",plot=challenge1,width = 15,height = 20, path = here::here("images"))

# Place picture in code
knitr::include_graphics(here::here("images", "challenge1.jpg"))

```

# Challenge 2:GDP components over time and among countries

Lets look at how GDP and its components have changed over time, and compare different countries and how much each component contributes to that country's GDP.

```{r read_GDP_data}

UN_GDP_data  <- read_excel(here::here("data", "Download-GDPconstant-USD-countries.xls"), # Excel filename
                sheet="Download-GDPconstant-USD-countr", # Sheet name
                skip=2) # Number of rows to skip

```

Lets start by tidying the data, turning it from a wide format into a long, tidy format. Lets also rename the column header to get something thats easier to work with.

```{r reshape_GDP_data}

#save lists for filter later 
components <- c("Gross capital formation", "Exports of goods and services", 	
"General government final consumption expenditure", "Household consumption expenditure (including Non-profit institutions serving households)", "Imports of goods and services","Gross Domestic Product (GDP)")

#transforming the dataframe from a wide to a long format
tidy_GDP_data  <-  UN_GDP_data %>% 
  pivot_longer(cols = (4:51), names_to = "Year", values_to = "Sum") %>% 
  mutate("Sum" = Sum/1e9) %>% 
  mutate(Year = as.numeric(Year))

data_renamed<- tidy_GDP_data%>%
 filter(IndicatorName %in% components) %>%   
pivot_wider(names_from = IndicatorName,values_from = Sum)
  
#renaming column headers
names(data_renamed)[4:9] <- c("HCE","GGFCE","GCF","EGS","IGS","GDP") 


glimpse(data_renamed)


# Let us compare GDP components for these 3 countries
country_list <- c("United States","India", "Germany")
```

Lets take a look at the differing GDP components over time

```{r, produce_the_plot, out.width="100%"}

components <- c("Gross capital formation", "Exports of goods and services", 	
"General government final consumption expenditure", "Household consumption expenditure (including Non-profit institutions serving households)", "Imports of goods and services")

components2 <- c("Gross capital formation", "Exports", 	
"Government expenditure", "Household expenditure", "Imports")

three_GDP <- tidy_GDP_data %>% 
  filter(Country %in% country_list) %>%
  filter(IndicatorName %in% components) 


gdp1 <- ggplot(data = three_GDP, aes(x = Year, y = Sum, group = IndicatorName, color = IndicatorName)) +
  geom_line(size = 0.8)+
  facet_wrap(~Country)+
  scale_color_manual( values=c("#F8766D", "#A3A500", "#2FCB95", "#00B0F6", "#E76BF3"),
                      name="Components of GDP",
                       labels= components2)+
  labs(x = "", y = "Billion US$", title = "GDP components over time", subtitle = "In constant 2010 USD")+
  theme(legend.position = "right")+
  theme_bw()+
  coord_equal(ratio = 0.008)

gdp1
```
Secondly,  recall that GDP is the sum of Household Expenditure (Consumption *C*), Gross Capital Formation (business investment *I*), Government Expenditure (G) and Net Exports (exports - imports). Lets calculate GDP using the above mentioned components.

```{r, calculate_gdp,out.width="100%"}

components3 <- c("Gross capital formation", "Exports of goods and services", 	
"General government final consumption expenditure", "Household consumption expenditure (including Non-profit institutions serving households)", "Imports of goods and services", "Gross Domestic Product (GDP)")

three_GDP <- data_renamed %>% 
  filter(Country %in% country_list)

three_GDP_1<- three_GDP %>% 
  mutate("Net_export" = EGS - IGS ) 

three_GDP_2 <- three_GDP_1 %>% 
  mutate("GDP_calculated" = HCE + GGFCE + GCF + Net_export)
three_GDP_3 <- three_GDP_2 %>% 
  mutate("GDP_difference_per" = (GDP - GDP_calculated) / GDP)

gdp_difference <- ggplot(data = three_GDP_3, aes(x = Year, y = GDP_difference_per)) + 
  geom_line(color = "#00B0F6", size = 0.8)+
  facet_wrap(~Country)+
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),limits = c(-0.08,0.07))+
  theme_bw()+
  labs(y = "Difference between reported and calculated GDP ", title = "With the exception of India, countries calculated GDP moved closer to the officialy reported one in recent years",subtitle = "Difference between GDP and calculated GDP")

gdp_difference
```

> What is the % difference between what you calculated as GDP and the GDP figure included in the dataframe?

For the US and Germany the difference between the two figures converged around zero % during the last years. Indias difference on the other hand has seen more variation in its GDP statistics, currently rising to an around 2% difference between the two values.

Lets now take a look at the differing components going into the GDP in these three countries.

```{r gdp_breakdown, out.width="100%"}

components4 <- c("Government Expenditure", "Gross capital formation", "Household Expenditure", "Net Exports")

three_GDP_4 <- three_GDP_3 %>% 
  mutate("GGFCE_per" = (GGFCE) / GDP) %>% 
  mutate("GCF_per" = (GCF) / GDP) %>% 
  mutate("HCE_per" = (HCE) / GDP) %>% 
  mutate("Net_export_per" = (Net_export) / GDP) %>% 
  select(Country, Year, GGFCE_per,GCF_per,HCE_per,Net_export_per)

three_GDP_5 <- three_GDP_4 %>% 
  pivot_longer(cols = (3:6), names_to = "Components", values_to = "Proportion" ) 

gdp2 <- ggplot(data = three_GDP_5, aes(x = Year, y = Proportion, group = Components, color = Components)) +
  geom_line(size = 1)+
  facet_wrap(~Country)+
  scale_color_manual( values=c("#F8766D", "#A3A500", "#2FCB95", "#E76BF3"),
                      name="",
                       labels= components4)+
  labs(x = "", y = "proportion", title = "GDP and its breakdown at constant 2010 prices in US Dollars", 
       caption = "Source: United Nations, https://unstats.un.org/unsd/snaama/Downloads") +
  theme(legend.position = "right")+
  theme_bw()+
  coord_equal(ratio = 80) + 
  theme(plot.title = element_text(face = "bold"))

#save the picture
ggsave("gdp2.jpg",plot=gdp2,width = 15,height = 7.5, path = here::here("images"))

#place the picture in code
knitr::include_graphics(here::here("images", "gdp2.jpg"))
```

> What is this last chart telling you? Can you explain in a couple of paragraphs the different dynamic among these three countries? 

Emerging countries such as India are experiencing an increase in gross capital formation as a result of large infrastructure and real estate investments. Additionally a decrease in household expenditure in India shows the lower priority of household expenditure for boosting the Indian economy.

Developed countries, such as the US and Germany have a relatively stable trend in these four components Countries that have solid industrial foundation, such as Germany, are going through an slight increase in net exports. 

# Details

- Who did you collaborate with: Group 7
- Approximately how much time did you spend on this problem set: 6 hours
- What, if anything, gave you the most trouble: Chart recreation



